<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Discipleship Admin Dashboard</title>
<style>
:root{
  --primary:#2b6cb0; --primary-dark:#225a90;
  --ok:#c6f6d5; --bad:#fed7d7;
  --bg:#f5f7fa; --text:#222;
}
body{font-family:Arial,sans-serif;margin:0;background:var(--bg);color:var(--text);transition:0.3s;}
button{cursor:pointer;transition:0.3s;}

/* Welcome Page */
.welcome-wrap{
  min-height:100vh; display:flex; align-items:center; justify-content:center;
  background: linear-gradient(270deg,#ff9a9e,#fad0c4,#fbc2eb,#a6c1ee);
  background-size:800% 800%; animation:gradientBG 15s ease infinite;
}
@keyframes gradientBG{
  0%{background-position:0% 50%;}
  50%{background-position:100% 50%;}
  100%{background-position:0% 50%;}
}
.welcome-card{
  max-width:700px;background:#fff;padding:28px;border-radius:16px;
  text-align:center;box-shadow:0 12px 30px rgba(0,0,0,0.12);
}
.logo{max-width:140px;margin-bottom:14px;}
.teacher-img{max-width:220px;border-radius:12px;display:block;margin:14px auto;}
.btn{display:inline-block;background:var(--primary);color:#fff;border:none;border-radius:8px;padding:0 16px;height:40px;line-height:40px;font-size:15px;}
.btn:hover{background:var(--primary-dark);}

/* Welcome Text Animation */
.welcome-title{font-size:22px;font-weight:700;color:#2b3a55;margin-bottom:8px;opacity:0;animation:fadeUp 1.2s ease forwards;}
.welcome-sub{font-size:14px;color:#444;margin-bottom:10px;line-height:1.5;opacity:0;animation:fadeUp 1.2s ease forwards;animation-delay:0.3s;}
.welcome-verse{font-size:13px;font-style:italic;color:#333;opacity:0;animation:fadeUp 1.2s ease forwards;animation-delay:0.6s;}
@keyframes fadeUp{0%{opacity:0;transform:translateY(12px);}100%{opacity:1;transform:translateY(0);}}

/* Dashboard */
.container{max-width:1200px;margin:20px auto;background:#fff;padding:18px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,0.08);}
input,select,textarea,button{font-family:inherit}
input,select,textarea{width:100%;padding:10px;margin:6px 0;border-radius:6px;border:1px solid #ccc;box-sizing:border-box;}
button{height:40px}
.tab-buttons{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap}
.tab-buttons button{flex:1;background:#eef5fb;border-radius:6px}
.tab-buttons button.active{background:var(--primary);color:#fff}
.tab-content{display:none}
.tab-content.active{display:block}
.number-input{display:flex;gap:8px;align-items:center}
.number-input button{width:44px;padding:0}
.lessons-row{display:flex;flex-wrap:wrap;gap:10px}
.lessons-row > div{flex:1 1 160px}
.table-container{overflow:auto;margin-top:14px;max-height:500px;position:relative;}
table{width:100%;border-collapse:collapse;table-layout:auto;margin-bottom:20px;min-width:800px;}
th,td{padding:8px;border:1px solid #e6eef6;text-align:left;white-space:nowrap;word-break:normal;}
th{background:var(--primary);color:#fff;position:sticky;top:0;z-index:1;user-select:none;}
td.yes{background:var(--ok);color:#22543d;text-align:center;font-weight:600;}
td.no{background:var(--bad);color:#822727;text-align:center;font-weight:600;}
.selected-row{outline:2px solid #ff9800; transition:0.3s;}
.highlight{background-color:#fff9c4;}
.admin-list{margin-top:12px;border:1px solid #eee;padding:10px;border-radius:6px}
.admin-list div{display:flex;justify-content:space-between;align-items:center;padding:6px 0}
.search-row{display:flex;gap:8px;align-items:center;margin-bottom:10px}
.search-row input{flex:1;padding:8px;border-radius:6px;border:1px solid #ccc;}
.pagination{margin-top:10px;display:flex;gap:6px;flex-wrap:wrap}
.small-muted{font-size:13px;color:#666}
.eye-icon{position:absolute;right:14px;top:35px;cursor:pointer;user-select:none;}
.position-relative{position:relative}

/* Highlight matching text inside cells */
#recordsContainer td .match { background-color: #ffff00; font-weight: 600; border-radius: 2px; padding: 0 2px; }

/* Dark theme */
body.dark{background:#121212;color:#f0f0f0}
body.dark .container{background:#1e1e1e}
body.dark input,body.dark select,body.dark textarea{background:#2c2c2c;color:#f0f0f0;border:1px solid #555;}
body.dark table th{background:#333}
body.dark table td.yes{background:#4caf50;color:#fff}
body.dark table td.no{background:#f44336;color:#fff}
body.dark .btn{background:#1976d2;color:#fff}
body.dark .btn:hover{background:#0d47a1}

/* Responsive */
@media(max-width:720px){.lessons-row>div{flex:1 1 100%}}
</style>
</head>
<body>

<!-- Welcome -->
<div id="welcomeView" class="welcome-wrap">
  <div class="welcome-card">
    <img src="logo.png" class="logo" alt="Logo">
    <h2 class="welcome-title">Welcome to Your Spiritual Home</h2>
    <p class="welcome-sub">
      Grow in faith, walk with purpose, and discover God‚Äôs calling for your life.
      This platform helps you build disciples, track growth, and strengthen your ministry.
    </p>
    <p class="welcome-verse">
      ‚ÄúYour word is a lamp to my feet and a light to my path.‚Äù ‚Äì Psalm 119:105
    </p>
    <img src="teacher.jfif" class="teacher-img" alt="Teacher">
    <button class="btn" id="proceedBtn">Proceed to Admin Login</button>
  </div>
</div>

<!-- Dashboard -->
<div id="dashboardView" class="container" style="display:none">
<h2>Discipleship Admin Dashboard</h2>
<button class="btn" onclick="toggleTheme()">Dark/Light</button>

<!-- Login -->
<div id="loginSection" style="display:none">
  <label>Username</label>
  <input id="adminUser" type="text">
  <div class="position-relative">
    <label>Password</label>
    <input id="adminPass" type="password">
    <span class="eye-icon" onclick="togglePassword('adminPass')">üëÅÔ∏è</span>
  </div>
  <button onclick="adminLogin()" class="btn">Login</button>
</div>

<div id="adminSection" style="display:none">
  <div class="search-row">
    <input id="globalSearchInput" placeholder="Search by name or phone..." oninput="loadRecords()">
  </div>
  <div class="tab-buttons">
    <button id="tabFormBtn" class="active" onclick="showTab('formTab')">Attendance Form</button>
    <button id="tabRecordsBtn" onclick="showTab('recordsTab')">Student Records</button>
    <button id="tabAdminsBtn" onclick="showTab('adminsTab')">Admin Accounts</button>
  </div>

  <!-- Attendance Form -->
  <div id="formTab" class="tab-content active">
    <h3>Add / Update Attendance</h3>
    <label>Student Name</label>
    <input id="studentName" type="text">
    <label>Phone</label>
    <div style="display:flex;gap:8px">
      <select id="countryCode" style="width:120px">
        <option value="+254">Kenya +254</option>
        <option value="+1">USA +1</option>
        <option value="+44">UK +44</option>
        <option value="+91">India +91</option>
        <option value="+234">Nigeria +234</option>
      </select>
      <input id="studentPhone" placeholder="Phone number">
    </div>
    <label>Class No.</label>
    <div class="number-input">
      <button onclick="changeClass(-1)">-</button>
      <input id="studentClass" type="number" min="1" max="12" value="1">
      <button onclick="changeClass(1)">+</button>
    </div>
    <h4>Lessons</h4>
    <div class="lessons-row" id="lessonsContainer"></div>
    <div style="display:flex;gap:12px;margin-top:12px">
      <button onclick="submitAttendance()" class="btn">Submit</button>
      <button onclick="clearForm()" style="background:#eee;color:#222;border-radius:6px;height:40px">Clear</button>
      <button onclick="deleteRecord()" style="background:#f44336;color:#fff;border-radius:6px;height:40px">Delete</button>
    </div>
  </div>

  <!-- Student Records -->
  <div id="recordsTab" class="tab-content">
    <h3>Student Records</h3>
    <div id="recordsContainer" class="table-container"></div>
  </div>

  <!-- Admin Accounts -->
  <div id="adminsTab" class="tab-content">
    <h3>Admin Accounts</h3>
    <label>New Username</label>
    <input id="newAdminUser">
    <label>New Password</label>
    <div class="position-relative">
      <input id="newAdminPass" type="password">
      <span class="eye-icon" onclick="togglePassword('newAdminPass')">üëÅÔ∏è</span>
    </div>
    <button onclick="addAdmin()" class="btn">Add Admin</button>
    <div class="admin-list" id="adminList"></div>
  </div>
</div>

<script>
// Lessons
const lessons=["Salvation","Temptation","Prayers","Bible","Fellowhip","Witnessing","Baptism","HolySpirit","Giving","Deliverance","Evangelism"];
lessons.forEach(l=>{
  const wrap=document.createElement('div');
  wrap.innerHTML=`<label style="font-weight:600">${l}:</label>
  <select data-lesson="${l}">
    <option value="no">No</option>
    <option value="yes">Yes</option>
  </select>`;
  document.getElementById('lessonsContainer').appendChild(wrap);
});

// Helpers
let db, selectedRecord=null;
function togglePassword(id){const i=document.getElementById(id);i.type=(i.type==='password')?'text':'password';}
function toggleTheme(){document.body.classList.toggle('dark');}
function changeClass(delta){
  const input=document.getElementById('studentClass');
  let v=parseInt(input.value||'1',10);v+=delta;if(v<1)v=1;if(v>12)v=12;input.value=v;
}
function showTab(id){
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.tab-buttons button').forEach(b=>b.classList.remove('active'));
  if(id==='formTab')document.getElementById('tabFormBtn').classList.add('active');
  else if(id==='recordsTab')document.getElementById('tabRecordsBtn').classList.add('active');
  else if(id==='adminsTab')document.getElementById('tabAdminsBtn').classList.add('active');
}

// Show dashboard after DB ready
document.getElementById('proceedBtn').addEventListener('click',()=>{
  document.getElementById('welcomeView').style.display='none';
  document.getElementById('dashboardView').style.display='block';
});

// IndexedDB setup
const request = indexedDB.open('DiscipleshipDB',1);
request.onupgradeneeded = e=>{
  db=e.target.result;
  db.createObjectStore('attendance',{keyPath:'id',autoIncrement:true});
  db.createObjectStore('admins',{keyPath:'username'});
};
request.onsuccess = e=>{
  db=e.target.result;
  loadAdmins().then(()=>{
    document.getElementById('loginSection').style.display='block';
  });
};

function loadAdmins(){
  return new Promise(resolve=>{
    const tx = db.transaction('admins','readonly').objectStore('admins');
    tx.getAll().onsuccess = e => {
      const admins = e.target.result;
      if(!admins.find(a=>a.username==='admin')){
        const wtx = db.transaction('admins','readwrite').objectStore('admins');
        wtx.add({username:'admin',password:'254@Discipleship',blocked:false}).onsuccess=()=>resolve();
      } else resolve();
      renderAdminList();
    };
  });
}

// Admin login
function adminLogin(){
  const u=document.getElementById('adminUser').value.trim();
  const p=document.getElementById('adminPass').value;
  if(!u||!p){alert('Enter credentials'); return;}
  const tx=db.transaction('admins','readonly').objectStore('admins');
  tx.get(u).onsuccess=e=>{
    const admin=e.target.result;
    if(!admin || admin.password!==p){alert('Wrong credentials'); return;}
    if(admin.blocked){alert('Blocked'); return;}
    document.getElementById('loginSection').style.display='none';
    document.getElementById('adminSection').style.display='block';
    loadRecords();
  };
}

// Attendance CRUD
function submitAttendance(){
  const student=document.getElementById('studentName').value.trim();
  const phone=document.getElementById('studentPhone').value.trim();
  const countryCode=document.getElementById('countryCode').value;
  const studentClass=document.getElementById('studentClass').value;
  if(!student||!phone){alert('Enter student name and phone');return;}
  const lessonData={};
  lessons.forEach(l=>{lessonData[l]=document.querySelector(`select[data-lesson="${l}"]`).value;});
  const tx=db.transaction('attendance','readwrite');
  const store=tx.objectStore('attendance');
  if(!selectedRecord){
    store.add({Student:student,Phone:countryCode+phone,"Class No.":studentClass,...lessonData}).onsuccess=()=>{alert('Submitted'); loadRecords(); clearForm();};
  } else {
    store.put({id:selectedRecord.id,Student:student,Phone:countryCode+phone,"Class No.":studentClass,...lessonData}).onsuccess=()=>{alert('Updated'); loadRecords(); clearForm();};
  }
}

// Delete record
function deleteRecord(){
  if(!selectedRecord){alert('Select record first'); return;}
  if(confirm('Delete this record?')){
    const tx=db.transaction('attendance','readwrite').objectStore('attendance').delete(selectedRecord.id);
    tx.onsuccess=()=>{alert('Deleted'); loadRecords(); clearForm();};
  }
}

// Clear form
function clearForm(){
  selectedRecord=null;
  document.getElementById('studentName').value='';
  document.getElementById('studentPhone').value='';
  document.getElementById('studentClass').value='1';
  lessons.forEach(l=>{document.querySelector(`select[data-lesson="${l}"]`).value='no';});
}

// Load records & highlight
function loadRecords(){
  const container = document.getElementById('recordsContainer'); 
  container.innerHTML = '';
  const val = document.getElementById('globalSearchInput').value.toLowerCase();
  const tx = db.transaction('attendance','readonly').objectStore('attendance');
  tx.getAll().onsuccess = e => {
    const records = e.target.result.filter(r => r.Student.toLowerCase().includes(val) || r.Phone.toLowerCase().includes(val) || r["Class No."].toString().includes(val));
    if(!records.length) return;
    const table = document.createElement('table');
    const thead = document.createElement('thead');
    const tr = document.createElement('tr');
    ['id','Student','Phone','Class No.',...lessons].forEach(k=>{const th=document.createElement('th'); th.textContent=k; tr.appendChild(th);});
    thead.appendChild(tr); table.appendChild(thead);
    const tbody = document.createElement('tbody');
    let firstMatchRow = null;
    records.forEach(r=>{
      const tr=document.createElement('tr');
      ['id','Student','Phone','Class No.',...lessons].forEach(f=>{
        const td=document.createElement('td'); 
        let cellText=r[f]||'';
        if(f!=='id' && val){const regex=new RegExp(`(${val.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`,'gi'); cellText=cellText.replace(regex, `<span class="match">$1</span>`);}
        td.innerHTML=cellText;
        if(lessons.includes(f)) td.className=(r[f]==='yes')?'yes':'no';
        tr.appendChild(td);
      });
      tr.onclick=()=>{selectedRecord=r; fillForm(r); document.querySelectorAll('#recordsContainer tr').forEach(row=>row.classList.remove('selected-row')); tr.classList.add('selected-row');};
      tbody.appendChild(tr);
      if(!firstMatchRow) firstMatchRow=tr;
    });
    table.appendChild(tbody); container.appendChild(table);
    if(firstMatchRow){firstMatchRow.scrollIntoView({behavior:'smooth',block:'center'});}
  };
}

// Fill form
function fillForm(r){
  showTab('formTab');
  document.getElementById('studentName').value=r.Student;
  const code=r.Phone.match(/^\+\d+/);
  if(code){document.getElementById('countryCode').value=code[0]; document.getElementById('studentPhone').value=r.Phone.replace(code[0],'');}
  else document.getElementById('studentPhone').value=r.Phone;
  document.getElementById('studentClass').value=r["Class No."];
  lessons.forEach(l=>document.querySelector(`select[data-lesson="${l}"]`).value=r[l]);
}

// Admin CRUD
function renderAdminList(){
  const container=document.getElementById('adminList'); container.innerHTML='';
  const tx = db.transaction('admins','readonly').objectStore('admins');
  tx.getAll().onsuccess = e => {
    e.target.result.forEach(a=>{
      const div=document.createElement('div'); div.innerHTML=`<span>${a.username}</span>`;
      const btn=document.createElement('button'); btn.textContent=a.blocked?'Unblock':'Block';
      btn.onclick=()=>{const wtx=db.transaction('admins','readwrite').objectStore('admins'); wtx.put({...a,blocked:!a.blocked}).onsuccess=()=>{renderAdminList();};};
      div.appendChild(btn); container.appendChild(div);
    });
  };
}

function addAdmin(){
  const u=document.getElementById('newAdminUser').value.trim();
  const p=document.getElementById('newAdminPass').value;
  if(!u||!p){alert('Enter username/password'); return;}
  const wtx=db.transaction('admins','readwrite').objectStore('admins');
  wtx.add({username:u,password:p,blocked:false}).onsuccess=()=>{alert('Added'); renderAdminList();};
  document.getElementById('newAdminUser').value=''; document.getElementById('newAdminPass').value='';
}
</script>
</body>
</html>
